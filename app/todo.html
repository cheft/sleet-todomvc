<item>
    <li class="{completed: todo.completed, editing: editing} todo">
        <div class="view">
            <input class="toggle" type="checkbox" checked="{todo.completed}" onclick="{toggleTodo}"/>
            <label ondblclick="{toEdit}">{todo.title}</label>
            <button class="destroy" onclick="{toRemove}"></button>
        </div>
        <input class="edit" name="editor" onblur="{didEdit}" onkeyup="{didEdit}"/>
    </li>
    todoTag = @parent.parent
    @todo = @parent.t
    @toEdit = (e) =>
        @editing = true
        @editor.value = @todo.title
    @didEdit = (e) =>
        if e.which is 13 or e.which is 0 
            @editing = false
            @todo.title = value.trim() if (value = e.target.value)
            todoTag.trigger 'save'
    @toRemove = => todoTag.trigger 'remove', @todo
    @toggleTodo = =>
        @todo.completed = !@todo.completed
        todoTag.trigger 'save'
        true
    @on 'update', =>  @editor.focus() if @editing
</item>
<todo>
    <section id="todoapp">
        <header id="header">
            <h1>todos</h1>
            <input id="new-todo" autofocus="" autocomplete="off" placeholder="What needs to be done?" onkeyup="{didAdd}"/>
        </header>
        <section id="main" if="{todos.length}">
            <input id="toggle-all" type="checkbox" checked="{allDone}" onclick="{toggleAll}"/>
            <ul id="todo-list"><item each="{t, i in filtered()}"></item></ul>
        </section>
        <footer id="footer" if="{todos.length}">
            <span id="todo-count">
                <strong>{remaining}</strong>
                {remaining > 1 ? 'items' : 'item'} left
            </span>
            <ul id="filters"><li each="{v in links}"><a class="{selected: parent.activeFilter == v.name}" href="#/{v.name}">{v.label}</a></li></ul>
            <button id="clear-completed" onclick="{removeCompleted}" if="{todos.length > remaining}">Clear completed</button>
        </footer>
    </section>
    <footer id="info">
        <p>Double-click to edit a todo</p>
        <p>
            Written by
            <a href="http://github.com/cheft">Cheft</a>
        </p>
        <p>
            Part of
            <a href="http://todomvc.com">TodoMVC</a>
        </p>
    </footer>
    store = new Store 'sleet-todo'
    @todos = store.fetch()
    @links = [{label: 'All', name: 'all'}, {label: 'Active', name: 'active'}, {label: 'Completed', name: 'completed'}]
    @didAdd = (e) =>
        if e.which is 13 and (value = e.target.value)
            @todos.push title: value.trim(), completed: false
            e.target.value = ''
            @trigger 'save'
    @filtered = =>
        return @todos if @activeFilter is 'all'
        @todos.filter (t) => t.completed is (if @activeFilter is 'active' then false else true)         
    @toggleAll = (e) =>
        @todos.forEach (t) => t.completed = e.target.checked
        @trigger 'save'
        true
    @removeCompleted = (e) =>
        @todos = @todos.filter (t) -> !t.completed
        @trigger 'save'
    @on 'remove', (todo) => @todos.forEach (t) =>
        @todos.splice(@todos.indexOf(t), 1) if todo is t
        @trigger 'save'
    @on 'save', =>
        store.save @todos
        @update()
    @on 'update', =>
        @remaining = (@todos.filter (t) -> !t.completed).length
        @allDone = @remaining is 0
    riot.route.exec (base, filter) => @activeFilter = filter || 'all'
    riot.route (base, filter) =>
        @activeFilter = filter
        @update()
        
</todo>
